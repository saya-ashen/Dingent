<!--
  Example Guest Chat Component for Dingent
  æ¸¸å®¢èŠå¤©ç»„ä»¶ç¤ºä¾‹

  This example shows how to integrate guest mode with your frontend.
  æ­¤ç¤ºä¾‹å±•ç¤ºå¦‚ä½•åœ¨å‰ç«¯é›†æˆæ¸¸å®¢æ¨¡å¼ã€‚
-->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dingent Guest Chat Example - æ¸¸å®¢èŠå¤©ç¤ºä¾‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
        }
        .assistant-message {
            background-color: #e9ecef;
            color: black;
        }
        .input-area {
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .info {
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            color: #0c5460;
        }
        .code {
            font-family: monospace;
            background-color: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– Dingent Guest Chat Example</h1>
    <p>æ¸¸å®¢èŠå¤©ç¤ºä¾‹ - æ— éœ€ç™»å½•å³å¯å¯¹è¯</p>

    <div class="info">
        <strong>Visitor ID (è®¿å®¢ ID):</strong> <span class="code" id="visitorId"></span>
        <br>
        <small>This ID is stored in your browser and identifies your chat sessions.
        æ­¤ ID å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ï¼Œç”¨äºè¯†åˆ«æ‚¨çš„èŠå¤©ä¼šè¯ã€‚</small>
    </div>

    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input
                type="text"
                id="messageInput"
                placeholder="è¾“å…¥æ¶ˆæ¯... Type your message..."
                onkeypress="if(event.key === 'Enter') sendMessage()"
            >
            <button onclick="sendMessage()" id="sendBtn">Send å‘é€</button>
        </div>
    </div>

    <script>
        // Configuration - é…ç½®
        const WORKSPACE_SLUG = 'default';  // Change to your workspace slug
        const AGENT_ID = 'default';        // Change to your agent ID
        const API_BASE_URL = 'http://localhost:8000/api/v1';

        // State - çŠ¶æ€
        let threadId = null;
        let isProcessing = false;

        // Get or create visitor ID - è·å–æˆ–åˆ›å»ºè®¿å®¢ ID
        function getVisitorId() {
            let visitorId = localStorage.getItem('dingent_visitor_id');

            if (!visitorId) {
                visitorId = crypto.randomUUID();
                localStorage.setItem('dingent_visitor_id', visitorId);
                console.log('New visitor ID created:', visitorId);
            }

            return visitorId;
        }

        // Initialize - åˆå§‹åŒ–
        const visitorId = getVisitorId();
        document.getElementById('visitorId').textContent = visitorId;

        // Create new thread - åˆ›å»ºæ–°å¯¹è¯
        function createNewThread() {
            threadId = crypto.randomUUID();
            console.log('New thread created:', threadId);
            return threadId;
        }

        // Add message to UI - åœ¨ç•Œé¢æ·»åŠ æ¶ˆæ¯
        function addMessageToUI(role, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Send message - å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || isProcessing) return;

            // Create thread if needed
            if (!threadId) {
                threadId = createNewThread();
            }

            // Disable input
            isProcessing = true;
            document.getElementById('sendBtn').disabled = true;
            input.disabled = true;

            // Add user message to UI
            addMessageToUI('user', message);
            input.value = '';

            try {
                const response = await fetch(
                    `${API_BASE_URL}/${WORKSPACE_SLUG}/chat/guest/agent/${AGENT_ID}/run`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Visitor-ID': visitorId,
                            'Accept': 'text/event-stream'
                        },
                        body: JSON.stringify({
                            thread_id: threadId,
                            run_id: crypto.randomUUID(),
                            messages: [
                                {
                                    id: crypto.randomUUID(),
                                    role: 'user',
                                    content: message
                                }
                            ],
                            state: {},
                            forwarded_props: {}
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Process SSE stream - å¤„ç†æœåŠ¡å™¨æ¨é€äº‹ä»¶æµ
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let assistantMessage = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                // Handle different event types
                                if (data.type === 'messages_snapshot') {
                                    // Initial messages - åˆå§‹æ¶ˆæ¯
                                    console.log('Messages snapshot:', data);
                                } else if (data.type === 'text_message_stream' && data.content) {
                                    // Streaming assistant response - æµå¼åŠ©æ‰‹å“åº”
                                    assistantMessage += data.content;
                                } else if (data.type === 'run_finished') {
                                    // Run completed - è¿è¡Œå®Œæˆ
                                    console.log('Run finished');
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }

                // Add final assistant message
                if (assistantMessage) {
                    addMessageToUI('assistant', assistantMessage);
                }

            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToUI('assistant', `é”™è¯¯ Error: ${error.message}`);
            } finally {
                // Re-enable input
                isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // Load conversation history - åŠ è½½å¯¹è¯å†å²
        async function loadConversationHistory() {
            try {
                const response = await fetch(
                    `${API_BASE_URL}/${WORKSPACE_SLUG}/chat/guest/threads`,
                    {
                        headers: {
                            'X-Visitor-ID': visitorId
                        }
                    }
                );

                if (response.ok) {
                    const threads = await response.json();
                    console.log('Your conversation history:', threads);

                    if (threads.length > 0) {
                        // You can implement a UI to select and load previous conversations
                        // æ‚¨å¯ä»¥å®ç°ä¸€ä¸ªç•Œé¢æ¥é€‰æ‹©å’ŒåŠ è½½ä¹‹å‰çš„å¯¹è¯
                        console.log('You have', threads.length, 'previous conversations');
                    }
                }
            } catch (error) {
                console.error('Error loading conversation history:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadConversationHistory();
            document.getElementById('messageInput').focus();
        });

        // Instructions
        console.log('='.repeat(50));
        console.log('Dingent Guest Chat Example');
        console.log('='.repeat(50));
        console.log('Your Visitor ID:', visitorId);
        console.log('To test:');
        console.log('1. Make sure Dingent server is running on http://localhost:8000');
        console.log('2. Type a message and press Enter or click Send');
        console.log('3. Check the Network tab to see API calls');
        console.log('='.repeat(50));
    </script>
</body>
</html>
